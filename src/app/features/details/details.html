<div class="details-page" [class.lang-transitioning]="isChangingLanguage()" *ngIf="!loading(); else loadingTpl">
  <!-- Error State -->
  <div class="error-state" *ngIf="error()">
    <mat-icon>error_outline</mat-icon>
    <h2 class="translate-text">{{ 'Error loading' | t }}</h2>
    <p>{{ error() }}</p>
    <button mat-flat-button routerLink="/">{{ 'Back to home' | t }}</button>
  </div>

  <ng-container *ngIf="!error() && item() as it">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-backdrop" [style.backgroundImage]="'url(' + backdrop() + ')'"></div>
      <div class="hero-gradient"></div>
      <div class="hero-vignette"></div>

      <div class="hero-content">
        <!-- Logo/Title Area -->
        <div class="title-area">
          <span class="media-badge">{{ mediaLabel() | t }}</span>
          <h1 class="title">{{ title() }}</h1>
          <p class="tagline" *ngIf="it.tagline">"{{ it.tagline }}"</p>
        </div>

        <!-- Meta Info -->
        <div class="meta-row">
          <span class="rating-badge" *ngIf="rating()">
            <mat-icon>star</mat-icon>
            {{ rating() }}
          </span>
          <span class="meta-item" *ngIf="year()">{{ year() }}</span>
          <span class="meta-divider" *ngIf="year() && runtimeLabel()"></span>
          <span class="meta-item" *ngIf="runtimeLabel()">{{ runtimeLabel() }}</span>
          <span class="meta-divider" *ngIf="seasonsLabel()"></span>
          <span class="meta-item translate-text" *ngIf="seasonsLabel() === '1'">{{ seasonsLabel() }} {{ 'season' | t }}</span>
          <span class="meta-item translate-text" *ngIf="seasonsLabel() && seasonsLabel() !== '1'">{{ seasonsLabel() }} {{ 'seasons' | t }}</span>
        </div>

        <!-- Genres -->
        <div class="genres" *ngIf="genres().length">
          <span class="genre" *ngFor="let g of genres(); let last = last">
            {{ g }}<span *ngIf="!last" class="genre-dot">•</span>
          </span>
        </div>

        <!-- Overview -->
        <p class="overview" *ngIf="overview(); else noOverview">{{ overview() }}</p>
        <ng-template #noOverview>
          <p class="overview translate-text">{{ 'No synopsis available.' | t }}</p>
        </ng-template>

        <!-- Crew Info -->
        <div class="crew-info">
          <div class="crew-item" *ngIf="directors().length">
            <span class="crew-label translate-text" *ngIf="directors().length > 1">{{ 'Directors:' | t }}</span>
            <span class="crew-label translate-text" *ngIf="directors().length === 1">{{ 'Director:' | t }}</span>
            <span class="crew-value">
              <ng-container *ngFor="let director of directors(); let last = last">
                <a class="crew-link" [routerLink]="['/person', director.id]">{{ director.name }}</a><span *ngIf="!last">, </span>
              </ng-container>
            </span>
          </div>
          <div class="crew-item" *ngIf="creators().length">
            <span class="crew-label translate-text" *ngIf="creators().length > 1">{{ 'Creators:' | t }}</span>
            <span class="crew-label translate-text" *ngIf="creators().length === 1">{{ 'Creator:' | t }}</span>
            <span class="crew-value">
              <ng-container *ngFor="let creator of creators(); let last = last">
                <a class="crew-link" [routerLink]="['/person', creator.id]">{{ creator.name }}</a><span *ngIf="!last">, </span>
              </ng-container>
            </span>
          </div>
          <div class="crew-item" *ngIf="writers().length">
            <span class="crew-label translate-text">{{ 'Writers:' | t }}</span>
            <span class="crew-value">
              <ng-container *ngFor="let writer of writers(); let last = last">
                <a class="crew-link" [routerLink]="['/person', writer.id]">{{ writer.name }}</a><span *ngIf="!last">, </span>
              </ng-container>
            </span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
          <button class="btn-play" (click)="play()">
            <mat-icon>play_arrow</mat-icon>
            <span class="translate-text">{{ 'Play' | t }}</span>
          </button>
          <button class="btn-trailer" *ngIf="hasTrailer()" (click)="openTrailer()">
            <mat-icon>movie</mat-icon>
            <span class="translate-text">{{ 'Watch Trailer' | t }}</span>
          </button>
          <button
            class="btn-secondary"
            [class.active]="inMyList()"
            (click)="toggleMyList()"
          >
            <mat-icon>{{ inMyList() ? 'check' : 'add' }}</mat-icon>
            <ng-container *ngIf="inMyList(); else addToList">
              <span class="translate-text">{{ 'In My List' | t }}</span>
            </ng-container>
            <ng-template #addToList>
              <span class="translate-text">{{ 'My List' | t }}</span>
            </ng-template>
          </button>
        </div>

        <!-- Playback Options -->
        <div class="playback-options">
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferMultiAudio()" (change)="toggleMultiAudio($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label translate-text">{{ 'Multi-audio' | t }}</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferSubtitles()" (change)="toggleSubtitles($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label translate-text">{{ 'With subtitles' | t }}</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferSeekable()" (change)="toggleSeekable($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label translate-text">{{ 'Seekable only' | t }}</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferYearInSearch()" (change)="toggleYearInSearch($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label translate-text">{{ 'Force year in search' | t }}</span>
          </label>
        </div>
      </div>

      <!-- Poster (visible on larger screens) -->
      <div class="hero-poster">
        <img [src]="poster()" [alt]="title()" />
      </div>
    </section>

    <section class="section episodes-section" *ngIf="isTv() && seasons().length">
      <div class="series-picker">
        <div class="series-header">
          <div class="series-title-group">
            <span class="series-heading translate-text">{{ 'Episodes' | t }}</span>
          </div>
        </div>
        <div class="season-picker">
          <div class="season-top">
            <span class="season-caption translate-text">{{ 'Season' | t }}</span>
            <div class="series-summary" *ngIf="seriesBadge() as badge">{{ badge }}</div>
          </div>
          <div class="season-list">
            <button
              class="season-chip"
              type="button"
              *ngFor="let season of seasons()"
              (click)="setSeason(season.season_number)"
              [class.active]="selectedSeason() === season.season_number"
              [attr.aria-pressed]="selectedSeason() === season.season_number">
              <span class="season-name">{{ formatSeasonLabel(season) }}</span>
              <span class="season-count translate-text" *ngIf="season.episode_count">
                {{ season.episode_count }} {{ 'Episodes' | t | lowercase }}
              </span>
            </button>
          </div>
        </div>

        <div class="netflix-episode-row-wrapper" *ngIf="!seasonEpisodesLoading() && episodeOptions().length">
          <div class="netflix-episode-row">
            <button
              class="netflix-episode-card"
              type="button"
              *ngFor="let episode of episodeOptions()"
              (click)="selectEpisode(episode.episode_number)"
              [class.active]="selectedEpisode() === episode.episode_number"
              [attr.aria-pressed]="selectedEpisode() === episode.episode_number">
              <div class="episode-thumbnail">
                <img [src]="episodeStill(episode)" [alt]="episodeTitle(episode)" loading="lazy" />
                <span class="episode-badge">E{{ episode.episode_number }}</span>
                <span class="episode-runtime" *ngIf="episodeRuntime(episode)">{{ episodeRuntime(episode) }}</span>
                <div class="thumbnail-overlay"></div>
                <button class="episode-play-btn" type="button" (click)="playEpisode(episode, $event)" aria-label="Play">
                  <mat-icon>play_arrow</mat-icon>
                </button>
              </div>
              
              <div class="episode-info">
                <h3 class="episode-name">{{ episodeTitle(episode) }}</h3>
                <p class="episode-description" *ngIf="episodeOverview(episode) as overview; else noEpisodeDesc">
                  {{ overview }}
                </p>
                <ng-template #noEpisodeDesc>
                  <p class="episode-description muted translate-text">{{ 'No description available.' | t }}</p>
                </ng-template>
              </div>
            </button>
          </div>
        </div>

        <div class="netflix-episode-row-wrapper" *ngIf="seasonEpisodesLoading()">
          <div class="netflix-episode-row skeleton">
            <div class="netflix-episode-card skeleton" *ngFor="let item of [1, 2, 3, 4, 5]">
              <div class="episode-thumbnail"></div>
              <div class="episode-info">
                <div class="skeleton-line title"></div>
                <div class="skeleton-line desc"></div>
                <div class="skeleton-line desc short"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="episodes-empty" *ngIf="!seasonEpisodesLoading() && episodeOptions().length === 0">
          <mat-icon>live_tv</mat-icon>
          <p class="translate-text">{{ 'No episodes available.' | t }}</p>
        </div>
      </div>
    </section>

    <!-- Cast Section -->
    <section class="section cast-section" *ngIf="cast().length">
      <h2 class="section-title translate-text">{{ 'Cast' | t }}</h2>
      <div class="cast-scroll">
        <a class="cast-card" *ngFor="let person of cast()" [routerLink]="['/person', person.id]">
          <div class="cast-image">
            <img
              [src]="person.profile || 'assets/placeholders/placeholder_movie.png'"
              [alt]="person.name"
              loading="lazy"
            />
          </div>
          <div class="cast-details">
            <div class="cast-name">{{ person.name }}</div>
            <div class="cast-role">{{ person.character }}</div>
          </div>
        </a>
      </div>
    </section>

    <!-- Details Section (Collapsible) -->
    <section class="section info-section">
      <button class="info-toggle" (click)="showInfo.set(!showInfo())">
        <div class="toggle-left">
          <mat-icon>info_outline</mat-icon>
          <span class="translate-text">{{ 'Additional information' | t }}</span>
        </div>
        <mat-icon class="toggle-arrow" [class.expanded]="showInfo()">expand_more</mat-icon>
      </button>

      <div class="info-content" *ngIf="showInfo()">
        <div class="info-chips">
          <!-- Quick Facts -->
          <div class="info-chip" *ngIf="releaseDateLabel()">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ releaseDateLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="runtimeLabel()">
            <mat-icon>schedule</mat-icon>
            <span>{{ runtimeLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="seasonsLabel()">
            <mat-icon>tv</mat-icon>
            <span class="translate-text" *ngIf="seasonsLabel() === '1'">{{ seasonsLabel() }} {{ 'season' | t }}</span>
            <span class="translate-text" *ngIf="seasonsLabel() !== '1'">{{ seasonsLabel() }} {{ 'seasons' | t }}</span>
          </div>
          <div class="info-chip" *ngIf="episodesLabel()">
            <mat-icon>video_library</mat-icon>
            <span class="translate-text">{{ episodesLabel() }} {{ 'Episodes' | t | lowercase }}</span>
          </div>
          <div class="info-chip" *ngIf="languageLabel()">
            <mat-icon>language</mat-icon>
            <span>{{ languageLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="countriesLabel()">
            <mat-icon>public</mat-icon>
            <span>{{ countriesLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="statusLabel()">
            <mat-icon>fiber_manual_record</mat-icon>
            <span>{{ statusLabel() }}</span>
          </div>
        </div>

        <div class="info-details">
          <div class="info-column" *ngIf="companiesLabel()">
            <span class="info-label translate-text">{{ 'Studios' | t }}</span>
            <span class="info-value">{{ companiesLabel() }}</span>
          </div>
          <div class="info-column" *ngIf="budgetLabel() !== '—'">
            <span class="info-label translate-text">{{ 'Budget' | t }}</span>
            <span class="info-value">{{ budgetLabel() }}</span>
          </div>
          <div class="info-column" *ngIf="revenueLabel() !== '—'">
            <span class="info-label translate-text">{{ 'Revenue' | t }}</span>
            <span class="info-value">{{ revenueLabel() }}</span>
          </div>
        </div>

        <a class="official-link" *ngIf="homepageLabel()" [href]="homepageLabel()" target="_blank" rel="noreferrer">
          <mat-icon>open_in_new</mat-icon>
          <span class="translate-text">{{ 'Visit official site' | t }}</span>
        </a>
      </div>
    </section>
  </ng-container>

  <!-- Trailer Modal -->
  <div class="trailer-modal" *ngIf="showTrailer()" (click)="closeTrailer()">
    <div class="trailer-container" (click)="$event.stopPropagation()">
      <button class="trailer-close" (click)="closeTrailer()">
        <mat-icon>close</mat-icon>
      </button>
      <iframe
        [title]="'Movie trailer' | t"
        [src]="trailerUrl() | safeUrl"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
      </iframe>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="details-page loading-state">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p class="translate-text">{{ 'Loading...' | t }}</p>
    </div>
  </div>
</ng-template>
