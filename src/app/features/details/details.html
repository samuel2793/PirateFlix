<div class="details-page" *ngIf="!loading(); else loadingTpl">
  <!-- Error State -->
  <div class="error-state" *ngIf="error()">
    <mat-icon>error_outline</mat-icon>
    <h2 i18n>Error loading</h2>
    <p>{{ error() }}</p>
    <button mat-flat-button routerLink="/" i18n>Back to home</button>
  </div>

  <ng-container *ngIf="!error() && item() as it">
    <!-- Hero Section -->
    <section class="hero">
      <div class="hero-backdrop" [style.backgroundImage]="'url(' + backdrop() + ')'"></div>
      <div class="hero-gradient"></div>
      <div class="hero-vignette"></div>

      <div class="hero-content">
        <!-- Logo/Title Area -->
        <div class="title-area">
          <span class="media-badge">{{ mediaLabel() }}</span>
          <h1 class="title">{{ title() }}</h1>
          <p class="tagline" *ngIf="it.tagline">"{{ it.tagline }}"</p>
        </div>

        <!-- Meta Info -->
        <div class="meta-row">
          <span class="rating-badge" *ngIf="rating()">
            <mat-icon>star</mat-icon>
            {{ rating() }}
          </span>
          <span class="meta-item" *ngIf="year()">{{ year() }}</span>
          <span class="meta-divider" *ngIf="year() && runtimeLabel()"></span>
          <span class="meta-item" *ngIf="runtimeLabel()">{{ runtimeLabel() }}</span>
          <span class="meta-divider" *ngIf="seasonsLabel()"></span>
          <span class="meta-item" *ngIf="seasonsLabel() === '1'" i18n>{{ seasonsLabel() }} season</span>
          <span class="meta-item" *ngIf="seasonsLabel() && seasonsLabel() !== '1'" i18n>{{ seasonsLabel() }} seasons</span>
        </div>

        <!-- Genres -->
        <div class="genres" *ngIf="genres().length">
          <span class="genre" *ngFor="let g of genres(); let last = last">
            {{ g }}<span *ngIf="!last" class="genre-dot">•</span>
          </span>
        </div>

        <!-- Overview -->
        <p class="overview" *ngIf="overview(); else noOverview">{{ overview() }}</p>
        <ng-template #noOverview>
          <p class="overview" i18n>No synopsis available.</p>
        </ng-template>

        <!-- Crew Info -->
        <div class="crew-info">
          <div class="crew-item" *ngIf="directors().length">
            <span class="crew-label" *ngIf="directors().length > 1" i18n>Directors:</span>
            <span class="crew-label" *ngIf="directors().length === 1" i18n>Director:</span>
            <span class="crew-value">{{ directors().join(', ') }}</span>
          </div>
          <div class="crew-item" *ngIf="creators().length">
            <span class="crew-label" *ngIf="creators().length > 1" i18n>Creators:</span>
            <span class="crew-label" *ngIf="creators().length === 1" i18n>Creator:</span>
            <span class="crew-value">{{ creators().join(', ') }}</span>
          </div>
          <div class="crew-item" *ngIf="writers().length">
            <span class="crew-label" i18n>Writers:</span>
            <span class="crew-value">{{ writers().join(', ') }}</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="actions">
          <button class="btn-play" (click)="play()">
            <mat-icon>play_arrow</mat-icon>
            <span i18n>Play</span>
          </button>
          <button class="btn-trailer" *ngIf="hasTrailer()" (click)="openTrailer()">
            <mat-icon>movie</mat-icon>
            <span i18n>Watch Trailer</span>
          </button>
          <button
            class="btn-secondary"
            [class.active]="inMyList()"
            (click)="toggleMyList()"
          >
            <mat-icon>{{ inMyList() ? 'check' : 'add' }}</mat-icon>
            <ng-container *ngIf="inMyList(); else addToList">
              <span i18n>In My List</span>
            </ng-container>
            <ng-template #addToList>
              <span i18n>My List</span>
            </ng-template>
          </button>
        </div>

        <!-- Playback Options -->
        <div class="playback-options">
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferMultiAudio()" (change)="toggleMultiAudio($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label" i18n>Multi-audio</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferSubtitles()" (change)="toggleSubtitles($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label" i18n>With subtitles</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferSeekable()" (change)="toggleSeekable($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label" i18n>Seekable only</span>
          </label>
          <label class="option-toggle">
            <input type="checkbox" [checked]="preferYearInSearch()" (change)="toggleYearInSearch($any($event.target).checked)" />
            <span class="toggle-track"></span>
            <span class="toggle-label" i18n>Force year in search</span>
          </label>
        </div>
      </div>

      <!-- Poster (visible on larger screens) -->
      <div class="hero-poster">
        <img [src]="poster()" [alt]="title()" />
      </div>
    </section>

    <!-- Cast Section -->
    <section class="section cast-section" *ngIf="cast().length">
      <h2 class="section-title" i18n>Cast</h2>
      <div class="cast-scroll">
        <a class="cast-card" *ngFor="let person of cast()" [routerLink]="['/person', person.id]">
          <div class="cast-image">
            <img
              [src]="person.profile || 'assets/placeholders/placeholder_movie.png'"
              [alt]="person.name"
              loading="lazy"
            />
          </div>
          <div class="cast-details">
            <div class="cast-name">{{ person.name }}</div>
            <div class="cast-role">{{ person.character }}</div>
          </div>
        </a>
      </div>
    </section>

    <!-- Details Section (Collapsible) -->
    <section class="section info-section">
      <button class="info-toggle" (click)="showInfo.set(!showInfo())">
        <div class="toggle-left">
          <mat-icon>info_outline</mat-icon>
          <span i18n>Additional information</span>
        </div>
        <mat-icon class="toggle-arrow" [class.expanded]="showInfo()">expand_more</mat-icon>
      </button>

      <div class="info-content" *ngIf="showInfo()">
        <div class="info-chips">
          <!-- Quick Facts -->
          <div class="info-chip" *ngIf="releaseDateLabel()">
            <mat-icon>calendar_today</mat-icon>
            <span>{{ releaseDateLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="runtimeLabel()">
            <mat-icon>schedule</mat-icon>
            <span>{{ runtimeLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="seasonsLabel()">
            <mat-icon>tv</mat-icon>
            <span *ngIf="seasonsLabel() === '1'" i18n>{{ seasonsLabel() }} season</span>
            <span *ngIf="seasonsLabel() !== '1'" i18n>{{ seasonsLabel() }} seasons</span>
          </div>
          <div class="info-chip" *ngIf="episodesLabel()">
            <mat-icon>video_library</mat-icon>
            <span i18n>{{ episodesLabel() }} episodes</span>
          </div>
          <div class="info-chip" *ngIf="languageLabel()">
            <mat-icon>language</mat-icon>
            <span>{{ languageLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="countriesLabel()">
            <mat-icon>public</mat-icon>
            <span>{{ countriesLabel() }}</span>
          </div>
          <div class="info-chip" *ngIf="statusLabel()">
            <mat-icon>fiber_manual_record</mat-icon>
            <span>{{ statusLabel() }}</span>
          </div>
        </div>

        <div class="info-details">
          <div class="info-column" *ngIf="companiesLabel()">
            <span class="info-label" i18n>Studios</span>
            <span class="info-value">{{ companiesLabel() }}</span>
          </div>
          <div class="info-column" *ngIf="budgetLabel() !== '—'">
            <span class="info-label" i18n>Budget</span>
            <span class="info-value">{{ budgetLabel() }}</span>
          </div>
          <div class="info-column" *ngIf="revenueLabel() !== '—'">
            <span class="info-label" i18n>Revenue</span>
            <span class="info-value">{{ revenueLabel() }}</span>
          </div>
        </div>

        <a class="official-link" *ngIf="homepageLabel()" [href]="homepageLabel()" target="_blank" rel="noreferrer">
          <mat-icon>open_in_new</mat-icon>
          <span i18n>Visit official site</span>
        </a>
      </div>
    </section>
  </ng-container>

  <!-- Trailer Modal -->
  <div class="trailer-modal" *ngIf="showTrailer()" (click)="closeTrailer()">
    <div class="trailer-container" (click)="$event.stopPropagation()">
      <button class="trailer-close" (click)="closeTrailer()">
        <mat-icon>close</mat-icon>
      </button>
      <iframe
        title="Movie trailer"
        i18n-title
        [src]="trailerUrl() | safeUrl"
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
      </iframe>
    </div>
  </div>
</div>

<ng-template #loadingTpl>
  <div class="details-page loading-state">
    <div class="loading-spinner">
      <div class="spinner"></div>
      <p i18n>Loading...</p>
    </div>
  </div>
</ng-template>
