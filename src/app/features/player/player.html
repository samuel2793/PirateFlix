<div class="player-page">
  @if (showPlayer()) {
    @if (loading()) {
      <div class="loading-overlay">
        <div class="loading-content">
          @if (loadingPhase() === 'resetting') {
            <h2>Preparando el servidor para el siguiente streaming...</h2>
            <p>Reiniciando conexiones, limpiando torrents y calentando mirrors.</p>
          } @else if (loadingPhase() === 'searching') {
            <h2>Buscando torrents disponibles...</h2>
            <p>Consultando mirrors y fuentes externas.</p>
          } @else {
            <h2>Cargando torrent...</h2>
            <p>Progreso: {{ loadingProgress() }}%</p>
            <div class="progress-bar">
              <div class="progress-fill" [style.width.%]="loadingProgress()"></div>
            </div>
          }
        </div>
      </div>
    }

    @if (errorMessage()) {
      <div class="error-message">
        <p>{{ errorMessage() }}</p>
      </div>
    }

    @if (videoSrc()) {
      <video #videoPlayer class="video" controls playsinline autoplay [src]="videoSrc()" crossorigin="anonymous"
        (loadedmetadata)="onVideoLoadedMetadata()">
        @for (subtitle of subtitleTracks(); track subtitle.index) {
          <track
            [label]="subtitle.language"
            kind="subtitles"
            [srclang]="getLanguageCode(subtitle.language)"
            [src]="subtitle.url"
            [default]="$index === 0">
        }
      </video>
    }
  }

  <div class="hud">
    <a routerLink="/" class="btn">‚Üê Home</a>
    <a [routerLink]="['/details', type(), id()]" class="btn">Detalles</a>
    <button class="btn settings-btn" (click)="toggleSettings()" title="Configuraci√≥n">
      ‚öôÔ∏è Ajustes
    </button>
  </div>

  <!-- Settings Panel -->
  @if (showSettings()) {
    <div class="settings-panel">
      <div class="settings-header">
        <div class="settings-tabs">
          <button 
            class="tab-btn" 
            [class.active]="settingsTab() === 'audio'" 
            (click)="setSettingsTab('audio')"
            [disabled]="audioTracks().length <= 1">
            üîä Audio
          </button>
          <button 
            class="tab-btn" 
            [class.active]="settingsTab() === 'subtitles'" 
            (click)="setSettingsTab('subtitles')"
            [disabled]="subtitleTracks().length === 0 && !canSearchOpenSubtitles()">
            üí¨ Subt√≠tulos
          </button>
          <button 
            class="tab-btn" 
            [class.active]="settingsTab() === 'appearance'" 
            (click)="setSettingsTab('appearance')"
            [disabled]="subtitleTracks().length === 0">
            üé® Apariencia
          </button>
        </div>
        <button class="close-btn" (click)="toggleSettings()" title="Cerrar">‚úï</button>
      </div>
      
      <div class="settings-content">
        <!-- Audio Tab -->
        @if (settingsTab() === 'audio') {
          <div class="tab-content">
            @if (audioTracks().length > 1) {
              <div class="setting-group">
                <label class="group-label">Pista de audio</label>
                <div class="audio-list">
                  <button 
                    class="audio-option" 
                    [class.active]="selectedAudioTrack() === 'auto'"
                    (click)="selectAudioTrack('auto')">
                    <span class="audio-icon">üîÑ</span>
                    <span class="audio-name">Autom√°tico</span>
                  </button>
                  @for (track of audioTracks(); track track.index) {
                    <button 
                      class="audio-option" 
                      [class.active]="selectedAudioTrack() === track.index"
                      (click)="selectAudioTrack(track.index)">
                      <span class="audio-icon">üîä</span>
                      <span class="audio-name">{{ formatAudioTrackLabel(track) }}</span>
                      @if (track.default) {
                        <span class="audio-badge">Por defecto</span>
                      }
                    </button>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üîá</span>
                <p>Solo hay una pista de audio disponible</p>
              </div>
            }
          </div>
        }

        <!-- Subtitles Tab -->
        @if (settingsTab() === 'subtitles') {
          <div class="tab-content">
            @if (subtitleTracks().length > 0) {
              <div class="setting-group">
                <label class="group-label">Pista de subt√≠tulos</label>
                <div class="subtitle-list">
                  <button 
                    class="subtitle-option" 
                    [class.active]="selectedSubtitleTrack() === -1"
                    (click)="selectSubtitleTrack(-1)">
                    <span class="sub-icon">üö´</span>
                    <span class="sub-name">Desactivados</span>
                  </button>
                  @for (track of subtitleTracks(); track track.index; let i = $index) {
                    <button 
                      class="subtitle-option" 
                      [class.active]="selectedSubtitleTrack() === i"
                      (click)="selectSubtitleTrack(i)">
                      <span class="sub-icon">üí¨</span>
                      <span class="sub-name">{{ track.language }}</span>
                    </button>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üí¨</span>
                <p>No hay subt√≠tulos disponibles</p>
              </div>
            }

            <div class="setting-group">
              <label class="group-label">Descargar desde OpenSubtitles</label>
              @if (!canSearchOpenSubtitles()) {
                <p class="open-subtitle-status">Carga un video para buscar subt√≠tulos externos.</p>
              } @else {
                <div class="open-subtitle-controls">
                  <input
                    class="lang-input"
                    type="text"
                    placeholder="Idiomas (es,en)"
                    [value]="openSubtitlesLanguages()"
                    (input)="setOpenSubtitlesLanguages($any($event.target).value)">
                  <button
                    class="action-btn"
                    (click)="searchOpenSubtitles()"
                    [disabled]="openSubtitlesLoading()">
                    Buscar
                  </button>
                </div>
                @if (openSubtitlesLoading()) {
                  <p class="open-subtitle-status">Buscando subt√≠tulos...</p>
                }
                @if (openSubtitlesError()) {
                  <p class="open-subtitle-status error">{{ openSubtitlesError() }}</p>
                }
                @if (!openSubtitlesLoading() && openSubtitlesLanguageOrder().length > 0) {
                  <div class="open-subtitle-list">
                    @for (languageKey of openSubtitlesLanguageOrder(); track languageKey) {
                      @if (currentOpenSubtitleResult(languageKey); as result) {
                        <div class="open-subtitle-item">
                          <span class="sub-icon">üåê</span>
                          <div class="open-subtitle-info">
                            <div class="open-subtitle-title">{{ formatOpenSubtitleTitle(result) }}</div>
                            @if (formatOpenSubtitleMeta(result)) {
                              <div class="open-subtitle-meta">{{ formatOpenSubtitleMeta(result) }}</div>
                            }
                          </div>
                          <div class="open-subtitle-actions">
                            <button class="download-btn" (click)="downloadOpenSubtitle(result)">
                              Descargar
                            </button>
                            <button
                              class="next-btn"
                              (click)="pickNextOpenSubtitle(languageKey)"
                              [disabled]="!hasNextOpenSubtitle(languageKey)">
                              No funciona
                            </button>
                          </div>
                        </div>
                      }
                    }
                  </div>
                } @else if (!openSubtitlesLoading() && !openSubtitlesError()) {
                  <p class="open-subtitle-status hint">
                    Usa "Buscar" para consultar OpenSubtitles.
                  </p>
                }
              }
            </div>
          </div>
        }

        <!-- Appearance Tab -->
        @if (settingsTab() === 'appearance') {
          <div class="tab-content">
            @if (subtitleTracks().length > 0) {
              <div class="setting-group">
                <label class="group-label">Tama√±o del texto</label>
                <div class="size-control">
                  <button class="size-btn" (click)="adjustSubtitleSize(-10)" [disabled]="subtitleSize() <= 50">‚àí</button>
                  <span class="size-value">{{ subtitleSize() }}%</span>
                  <button class="size-btn" (click)="adjustSubtitleSize(10)" [disabled]="subtitleSize() >= 200">+</button>
                </div>
                <div class="size-presets">
                  <button class="preset-btn" [class.active]="subtitleSize() === 75" (click)="setSubtitleSize(75)">Peque√±o</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 100" (click)="setSubtitleSize(100)">Normal</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 125" (click)="setSubtitleSize(125)">Grande</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 150" (click)="setSubtitleSize(150)">Muy grande</button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label">Color del texto</label>
                <div class="color-grid">
                  <button class="color-option color-white" [class.active]="subtitleColor() === '#ffffff'" (click)="setSubtitleColor('#ffffff')" title="Blanco">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-yellow" [class.active]="subtitleColor() === '#ffff00'" (click)="setSubtitleColor('#ffff00')" title="Amarillo">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-green" [class.active]="subtitleColor() === '#00ff00'" (click)="setSubtitleColor('#00ff00')" title="Verde">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-cyan" [class.active]="subtitleColor() === '#00ffff'" (click)="setSubtitleColor('#00ffff')" title="Cian">
                    <span class="check">‚úì</span>
                  </button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label">Fondo</label>
                <div class="bg-options">
                  <button class="bg-option" [class.active]="subtitleBackground() === 'rgba(0,0,0,0.7)'" (click)="setSubtitleBackground('rgba(0,0,0,0.7)')">
                    <span class="bg-preview bg-semi"></span>
                    <span>Semi</span>
                  </button>
                  <button class="bg-option" [class.active]="subtitleBackground() === 'rgba(0,0,0,0.9)'" (click)="setSubtitleBackground('rgba(0,0,0,0.9)')">
                    <span class="bg-preview bg-solid"></span>
                    <span>S√≥lido</span>
                  </button>
                  <button class="bg-option" [class.active]="subtitleBackground() === 'transparent'" (click)="setSubtitleBackground('transparent')">
                    <span class="bg-preview bg-none"></span>
                    <span>Ninguno</span>
                  </button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label">Tipo de letra</label>
                <div class="font-options">
                  <button class="font-option" [class.active]="subtitleFont() === 'sans-serif'" (click)="setSubtitleFont('sans-serif')">
                    <span class="font-preview font-sans">Aa</span>
                    <span>Sans Serif</span>
                  </button>
                  <button class="font-option" [class.active]="subtitleFont() === 'serif'" (click)="setSubtitleFont('serif')">
                    <span class="font-preview font-serif">Aa</span>
                    <span>Serif</span>
                  </button>
                  <button class="font-option" [class.active]="subtitleFont() === 'monospace'" (click)="setSubtitleFont('monospace')">
                    <span class="font-preview font-mono">Aa</span>
                    <span>Mono</span>
                  </button>
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üé®</span>
                <p>Activa los subt√≠tulos para personalizar su apariencia</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
