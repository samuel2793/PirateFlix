<div class="player-page">
  @if (showPlayer()) {
    @if (loading()) {
      <div class="loading-overlay">
        <div class="loading-content">
          @if (loadingPhase() === 'resetting') {
            <h2 class="translate-text">{{ 'Preparing the server for the next stream...' | t }}</h2>
          } @else if (loadingPhase() === 'searching') {
            <h2 class="translate-text">{{ 'Searching for available torrents...' | t }}</h2>
          } @else {
            <h2 class="translate-text">{{ 'Connecting to the torrent...' | t }}</h2>
          }

          @if (showTranscodeUI()) {
            <div class="transcode-status" aria-live="polite">
              <div class="transcode-title">{{ transcodeLabel() }}</div>
              <div class="transcode-meta">
                @if (transcodePercent() !== null) {
                  <span class="transcode-percent">{{ transcodePercent() | number:'1.0-0' }}%</span>
                } @else {
                  <span class="transcode-percent" i18n>Calculating...</span>
                }
                @if (transcodeEta()) {
                  <span class="transcode-eta">{{ transcodeEta() }}</span>
                }
              </div>
              <div class="progress-bar" [class.indeterminate]="transcodePercent() === null">
                <div class="progress-fill" [style.width.%]="transcodePercent() ?? 0"></div>
              </div>
            </div>
          } @else {
            <ul class="loading-logs" aria-live="polite">
              @if (loadingLogs().length === 0) {
                <li class="loading-log muted" i18n>Gathering status updates...</li>
              } @else {
                @for (entry of loadingLogs(); track entry.id) {
                  <li class="loading-log" [class.warn]="entry.level === 'warn'" [class.error]="entry.level === 'error'">
                    <span class="log-icon" aria-hidden="true">
                      @if (entry.level === 'error') { x }
                      @else if (entry.level === 'warn') { ! }
                      @else { > }
                    </span>
                    <span class="log-message">{{ entry.message }}</span>
                  </li>
                }
              }
            </ul>
          }
        </div>
      </div>
    }

    @if (errorMessage()) {
      <div class="error-message">
        <p>{{ errorMessage() }}</p>
      </div>
    }

    @if (videoSrc()) {
      <video #videoPlayer class="video" controls playsinline autoplay [src]="videoSrc()" crossorigin="anonymous"
        (loadedmetadata)="onVideoLoadedMetadata()"
        (error)="onVideoError()">
        @for (subtitle of subtitleTracks(); track subtitle.index) {
          <track
            [label]="subtitle.language"
            kind="subtitles"
            [srclang]="getLanguageCode(subtitle.language)"
            [src]="subtitle.url"
            [default]="$index === 0">
        }
      </video>
    }
  }

  <div class="hud">
    <a routerLink="/" class="btn">‚Üê <span class="translate-text">{{ 'Home' | t }}</span></a>
    <a [routerLink]="['/details', type(), id()]" class="btn"><span class="translate-text">{{ 'Details' | t }}</span></a>
    <button class="btn settings-btn" (click)="toggleSettings()" [title]="'Settings' | t">
      ‚öôÔ∏è <span class="translate-text">{{ 'Settings' | t }}</span>
    </button>
  </div>

  <!-- Settings Panel -->
  @if (showSettings()) {
    <div class="settings-panel">
      <div class="settings-header">
        <div class="settings-tabs">
          <button
            class="tab-btn"
            [class.active]="settingsTab() === 'audio'"
            (click)="setSettingsTab('audio')"
            [disabled]="audioTracks().length <= 1">
            üîä <span class="translate-text">{{ 'Audio' | t }}</span>
          </button>
          <button
            class="tab-btn"
            [class.active]="settingsTab() === 'subtitles'"
            (click)="setSettingsTab('subtitles')"
            [disabled]="subtitleTracks().length === 0 && !canSearchOpenSubtitles()">
            üí¨ <span class="translate-text">{{ 'Subtitles' | t }}</span>
          </button>
          <button
            class="tab-btn"
            [class.active]="settingsTab() === 'appearance'"
            (click)="setSettingsTab('appearance')"
            [disabled]="subtitleTracks().length === 0">
            üé® <span class="translate-text">{{ 'Appearance' | t }}</span>
          </button>
        </div>
        <button class="close-btn" (click)="toggleSettings()" [title]="'Close' | t">‚úï</button>
      </div>

      <div class="settings-content">
        <!-- Audio Tab -->
        @if (settingsTab() === 'audio') {
          <div class="tab-content">
            @if (audioTracks().length > 1) {
              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Audio track' | t }}</label>
                <div class="audio-list">
                  <button
                    class="audio-option"
                    [class.active]="selectedAudioTrack() === 'auto'"
                    (click)="selectAudioTrack('auto')">
                    <span class="audio-icon">üîÑ</span>
                    <span class="audio-name translate-text">{{ 'Auto' | t }}</span>
                    @if (audioSwitching() && audioSwitchTrack() === 'auto') {
                      <span class="audio-badge pending">Descargando...</span>
                    }
                  </button>
                  @for (track of audioTracks(); track track.index) {
                    <button
                      class="audio-option"
                      [class.active]="selectedAudioTrack() === track.index"
                      (click)="selectAudioTrack(track.index)">
                      <span class="audio-icon">üîä</span>
                      <span class="audio-name">{{ formatAudioTrackLabel(track) }}</span>
                      @if (track.default) {
                        <span class="audio-badge translate-text">{{ 'Default' | t }}</span>
                      }
                      @if (audioSwitching() && audioSwitchTrack() === track.index) {
                        <span class="audio-badge pending">Descargando...</span>
                      }
                    </button>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üîá</span>
                <p class="translate-text">{{ 'Only one audio track is available' | t }}</p>
              </div>
            }
          </div>
        }

        <!-- Subtitles Tab -->
        @if (settingsTab() === 'subtitles') {
          <div class="tab-content">
            @if (subtitleTracks().length > 0) {
              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Subtitle track' | t }}</label>
                <div class="subtitle-list">
                  <button
                    class="subtitle-option"
                    [class.active]="selectedSubtitleTrack() === -1"
                    (click)="selectSubtitleTrack(-1)">
                    <span class="sub-icon">üö´</span>
                    <span class="sub-name translate-text">{{ 'Off' | t }}</span>
                  </button>
                  @for (track of subtitleTracks(); track track.index; let i = $index) {
                    <button
                      class="subtitle-option"
                      [class.active]="selectedSubtitleTrack() === i"
                      (click)="selectSubtitleTrack(i)">
                      <span class="sub-icon">üí¨</span>
                      <span class="sub-name">{{ track.language }}</span>
                    </button>
                  }
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üí¨</span>
                <p class="translate-text">{{ 'No subtitles available' | t }}</p>
              </div>
            }

            <div class="setting-group">
              <label class="group-label translate-text">{{ 'Download from OpenSubtitles' | t }}</label>
              @if (!canSearchOpenSubtitles()) {
                <p class="open-subtitle-status translate-text">{{ 'Load a video to search for external subtitles.' | t }}</p>
              } @else {
                <div class="open-subtitle-controls">
                  <input
                    class="lang-input"
                    type="text"
                    [placeholder]="'Languages (en,es)' | t"
                    [value]="openSubtitlesLanguages()"
                    (input)="setOpenSubtitlesLanguages($any($event.target).value)">
                  <button
                    class="action-btn"
                    (click)="searchOpenSubtitles()"
                    [disabled]="openSubtitlesLoading()">
                    <span class="translate-text">{{ 'Search' | t }}</span>
                  </button>
                </div>
                @if (openSubtitlesLoading()) {
                  <p class="open-subtitle-status translate-text">{{ 'Searching for subtitles...' | t }}</p>
                }
                @if (openSubtitlesError()) {
                  <p class="open-subtitle-status error">{{ openSubtitlesError() }}</p>
                }
                @if (!openSubtitlesLoading() && openSubtitlesLanguageOrder().length > 0) {
                  <div class="open-subtitle-list">
                    @for (languageKey of openSubtitlesLanguageOrder(); track languageKey) {
                      @if (currentOpenSubtitleResult(languageKey); as result) {
                        <div class="open-subtitle-item">
                          <span class="sub-icon">üåê</span>
                          <div class="open-subtitle-info">
                            <div class="open-subtitle-title">{{ formatOpenSubtitleTitle(result) }}</div>
                            @if (formatOpenSubtitleMeta(result)) {
                              <div class="open-subtitle-meta">{{ formatOpenSubtitleMeta(result) }}</div>
                            }
                          </div>
                          <div class="open-subtitle-actions">
                            <button class="download-btn" (click)="downloadOpenSubtitle(result)">
                              <span class="translate-text">{{ 'Download' | t }}</span>
                            </button>
                            <button
                              class="next-btn"
                              (click)="pickNextOpenSubtitle(languageKey)"
                              [disabled]="!hasNextOpenSubtitle(languageKey)">
                              <span class="translate-text">{{ "Doesn't work" | t }}</span>
                            </button>
                          </div>
                        </div>
                      }
                    }
                  </div>
                } @else if (!openSubtitlesLoading() && !openSubtitlesError()) {
                  <p class="open-subtitle-status hint translate-text">{{ 'Use "Search" to query OpenSubtitles.' | t }}</p>
                }
              }
            </div>
          </div>
        }

        <!-- Appearance Tab -->
        @if (settingsTab() === 'appearance') {
          <div class="tab-content">
            @if (subtitleTracks().length > 0) {
              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Text size' | t }}</label>
                <div class="size-control">
                  <button class="size-btn" (click)="adjustSubtitleSize(-10)" [disabled]="subtitleSize() <= 50">‚àí</button>
                  <span class="size-value">{{ subtitleSize() }}%</span>
                  <button class="size-btn" (click)="adjustSubtitleSize(10)" [disabled]="subtitleSize() >= 200">+</button>
                </div>
                <div class="size-presets">
                  <button class="preset-btn" [class.active]="subtitleSize() === 75" (click)="setSubtitleSize(75)">{{ 'Small' | t }}</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 100" (click)="setSubtitleSize(100)">{{ 'Normal' | t }}</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 125" (click)="setSubtitleSize(125)">{{ 'Large' | t }}</button>
                  <button class="preset-btn" [class.active]="subtitleSize() === 150" (click)="setSubtitleSize(150)">{{ 'Extra large' | t }}</button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Text color' | t }}</label>
                <div class="color-grid">
                  <button class="color-option color-white" [class.active]="subtitleColor() === '#ffffff'" (click)="setSubtitleColor('#ffffff')" [title]="'White' | t">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-yellow" [class.active]="subtitleColor() === '#ffff00'" (click)="setSubtitleColor('#ffff00')" [title]="'Yellow' | t">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-green" [class.active]="subtitleColor() === '#00ff00'" (click)="setSubtitleColor('#00ff00')" [title]="'Green' | t">
                    <span class="check">‚úì</span>
                  </button>
                  <button class="color-option color-cyan" [class.active]="subtitleColor() === '#00ffff'" (click)="setSubtitleColor('#00ffff')" [title]="'Cyan' | t">
                    <span class="check">‚úì</span>
                  </button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Background' | t }}</label>
                <div class="bg-options">
                  <button class="bg-option" [class.active]="subtitleBackground() === 'rgba(0,0,0,0.7)'" (click)="setSubtitleBackground('rgba(0,0,0,0.7)')">
                    <span class="bg-preview bg-semi"></span>
                    <span class="translate-text">{{ 'Semi' | t }}</span>
                  </button>
                  <button class="bg-option" [class.active]="subtitleBackground() === 'rgba(0,0,0,0.9)'" (click)="setSubtitleBackground('rgba(0,0,0,0.9)')">
                    <span class="bg-preview bg-solid"></span>
                    <span class="translate-text">{{ 'Solid' | t }}</span>
                  </button>
                  <button class="bg-option" [class.active]="subtitleBackground() === 'transparent'" (click)="setSubtitleBackground('transparent')">
                    <span class="bg-preview bg-none"></span>
                    <span class="translate-text">{{ 'None' | t }}</span>
                  </button>
                </div>
              </div>

              <div class="setting-group">
                <label class="group-label translate-text">{{ 'Font' | t }}</label>
                <div class="font-options">
                  <button class="font-option" [class.active]="subtitleFont() === 'sans-serif'" (click)="setSubtitleFont('sans-serif')">
                    <span class="font-preview font-sans">Aa</span>
                    <span class="translate-text">{{ 'Sans Serif' | t }}</span>
                  </button>
                  <button class="font-option" [class.active]="subtitleFont() === 'serif'" (click)="setSubtitleFont('serif')">
                    <span class="font-preview font-serif">Aa</span>
                    <span class="translate-text">{{ 'Serif' | t }}</span>
                  </button>
                  <button class="font-option" [class.active]="subtitleFont() === 'monospace'" (click)="setSubtitleFont('monospace')">
                    <span class="font-preview font-mono">Aa</span>
                    <span class="translate-text">{{ 'Mono' | t }}</span>
                  </button>
                </div>
              </div>
            } @else {
              <div class="empty-state">
                <span class="empty-icon">üé®</span>
                <p class="translate-text">{{ 'Enable subtitles to customize their appearance' | t }}</p>
              </div>
            }
          </div>
        }
      </div>
    </div>
  }
</div>
